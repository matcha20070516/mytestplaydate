<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¨¡è©¦çµ±è¨ˆ - TExAM</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background: #f6f8fb;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    h1 {
      color: #333;
      font-size: 1.8em;
    }

    .back-btn {
      background: #e0e0e0;
      color: #333;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #d0d0d0;
    }

    .header-desc {
      color: #666;
      font-size: 0.95em;
      margin-top: 8px;
    }

    /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
    .stats-grid {
      display: grid;
      gap: 20px;
      margin-bottom: 20px;
    }

    .exam-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s;
    }

    .exam-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .exam-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f0f0f0;
    }

    .exam-title {
      font-size: 1.4em;
      font-weight: 600;
      color: #333;
    }

    .exam-status {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .exam-status.published {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .exam-status.coming-soon {
      background: #fff3e0;
      color: #e65100;
    }

    /* çµ±è¨ˆè¡¨ç¤º */
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #e0e0e0;
    }

    .stat-label {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 1.8em;
      font-weight: 700;
      color: #5da3fa;
    }

    .stat-value.highlight {
      color: #e53935;
      font-size: 2.2em;
    }

    /* ç´šåˆ¥åˆ†å¸ƒã‚°ãƒ©ãƒ•ï¼ˆç¸¦æ£’ã‚°ãƒ©ãƒ•ï¼‰ */
    .grade-distribution {
      margin-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 12px;
    }

    .grade-distribution h3 {
      font-size: 1.1em;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 300px;
      gap: 8px;
      padding: 20px 10px;
      border-bottom: 2px solid #333;
      position: relative;
    }

    /* Yè»¸ã®ã‚°ãƒªãƒƒãƒ‰ç·š */
    .bar-chart::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 100%;
      background: 
        linear-gradient(to bottom, transparent 0%, transparent calc(100% - 2px), #ddd calc(100% - 2px), #ddd 100%),
        repeating-linear-gradient(to bottom, transparent 0px, transparent calc(20% - 1px), #f0f0f0 calc(20% - 1px), #f0f0f0 20%);
      pointer-events: none;
    }

    .bar-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .bar-fill-vertical {
      width: 100%;
      max-width: 60px;
      background: linear-gradient(to top, #ff6b6b 0%, #ffb4b4 100%);
      border-radius: 4px 4px 0 0;
      transition: height 0.8s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding-top: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .bar-percent-top {
      font-size: 0.9em;
      font-weight: 700;
      color: #c62828;
    }

    .bar-label-bottom {
      margin-top: 8px;
      font-size: 0.9em;
      font-weight: 600;
      color: #333;
    }

    .bar-count-bottom {
      font-size: 0.8em;
      color: #666;
      margin-top: 2px;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ç©ºçŠ¶æ…‹ */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .loading-icon {
      font-size: 3em;
      margin-bottom: 16px;
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 4em;
      margin-bottom: 16px;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #1565c0;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <div class="header-top">
        <h1>ğŸ“Š æ¨¡è©¦çµ±è¨ˆ</h1>
        <button class="back-btn" onclick="location.href='index.html'">â† ãƒ›ãƒ¼ãƒ ã¸</button>
      </div>
      <p class="header-desc">å„æ¨¡è©¦ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™</p>
    </div>

    <div class="info-box">
      ğŸ’¡ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¯å—é¨“ã‹ã‚‰1é€±é–“å¾Œã«è‡ªå‹•å…¬é–‹ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯å…¬é–‹å¾…ã¡ã§ã™ã€‚
    </div>

    <!-- çµ±è¨ˆä¸€è¦§ -->
    <div id="statsGrid" class="stats-grid">
      <div class="loading">
        <div class="loading-icon">ğŸ“ˆ</div>
        <p>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBhnEso3ozk4xG0k9x-69DC0HrKs8flzeU",
      authDomain: "mytestplaydate-4bc69.firebaseapp.com",
      projectId: "mytestplaydate-4bc69",
      storageBucket: "mytestplaydate-4bc69.firebasestorage.app",
      messagingSenderId: "995628219885",
      appId: "1:995628219885:web:333b93e79445febd3fbbe4",
      measurementId: "G-H1XRB359QB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadAllStats() {
      const statsGrid = document.getElementById('statsGrid');
      
      try {
        const statsSnapshot = await getDocs(collection(db, "examStats"));
        
        if (statsSnapshot.empty) {
          statsGrid.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">ğŸ“­</div>
              <p>ã¾ã çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
              <p style="font-size: 0.9em; margin-top: 8px;">æ¨¡è©¦ã‚’å—é¨“ã™ã‚‹ã¨çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
          `;
          return;
        }

        const statsArray = [];
        statsSnapshot.forEach(doc => {
          const data = doc.data();
          statsArray.push({
            id: doc.id,
            ...data
          });
        });

        // æ›´æ–°æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆ
        statsArray.sort((a, b) => {
          const aTime = a.lastUpdated?.seconds || 0;
          const bTime = b.lastUpdated?.seconds || 0;
          return bTime - aTime;
        });

        // ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
        statsGrid.innerHTML = statsArray.map(exam => renderExamCard(exam)).join('');

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        setTimeout(() => {
          document.querySelectorAll('.bar-fill-vertical').forEach(bar => {
            bar.style.height = bar.getAttribute('data-height');
          });
        }, 100);

      } catch (error) {
        console.error("çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
        statsGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <p>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
            <p style="font-size: 0.9em; margin-top: 8px; color: #666;">${error.message}</p>
          </div>
        `;
      }
    }

    // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
    function renderExamCard(exam) {
      const average = Math.round(exam.totalScore / exam.totalCount);
      
      // æº€ç‚¹äººæ•°ã‚’è¨ˆç®—
      const perfectCount = exam.gradeCount?.['grade_1'] || 0;
      
      // å…¬é–‹åˆ¤å®šï¼ˆãƒ†ã‚¹ãƒˆç”¨: ã™ãå…¬é–‹ï¼‰
      const now = new Date();
      const createdAt = exam.createdAt?.toDate?.() || new Date(exam.createdAt);
      const daysPassed = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
      const isPublished = true; // ãƒ†ã‚¹ãƒˆç”¨ã«å¸¸ã«å…¬é–‹

      // ç´šåˆ¥åˆ†å¸ƒãƒ‡ãƒ¼ã‚¿
      const gradeOrder = ['1', 'æº–1', '2', 'æº–2', '3', '4', '5', '6', '7', '8'];
      const gradeLabels = ['1ç´š', 'æº–1ç´š', '2ç´š', 'æº–2ç´š', '3ç´š', '4ç´š', '5ç´š', '6ç´š', '7ç´š', '8ç´š'];
      const gradeDistribution = gradeOrder.map((g, idx) => {
        const key = `grade_${g}`;
        const count = exam.gradeCount?.[key] || 0;
        const percent = exam.totalCount > 0 ? ((count / exam.totalCount) * 100).toFixed(1) : 0;
        return {
          grade: gradeLabels[idx],
          count,
          percent: parseFloat(percent)
        };
      });

      return `
        <div class="exam-card">
          <div class="exam-header">
            <h2 class="exam-title">${exam.setName || exam.id}</h2>
            <span class="exam-status ${isPublished ? 'published' : 'coming-soon'}">
              ${isPublished ? 'å…¬é–‹ä¸­' : `å…¬é–‹ã¾ã§ ${7 - daysPassed}æ—¥`}
            </span>
          </div>

          ${isPublished ? `
            <div class="stats-summary">
              <div class="stat-box">
                <div class="stat-label">å—é¨“è€…ç·æ•°</div>
                <div class="stat-value highlight">${exam.totalCount}äºº</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">å¹³å‡ç‚¹</div>
                <div class="stat-value">${average}ç‚¹</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">æº€ç‚¹äººæ•°</div>
                <div class="stat-value">${perfectCount}äºº</div>
              </div>
            </div>

            <div class="grade-distribution">
              <h3>ç´šåˆ¥åˆ†å¸ƒ</h3>
              <div class="bar-chart">
                ${gradeDistribution.map(g => `
                  <div class="bar-column">
                    <div class="bar-fill-vertical" style="height: 0%" data-height="${g.percent * 3}%">
                      <span class="bar-percent-top">${g.percent}%</span>
                    </div>
                    <div class="bar-label-bottom">${g.grade}</div>
                    <div class="bar-count-bottom">${g.count}äºº</div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : `
            <div style="text-align: center; padding: 40px 20px; color: #999;">
              <div style="font-size: 3em; margin-bottom: 16px;">ğŸ”’</div>
              <p>ã“ã®æ¨¡è©¦ã®çµ±è¨ˆã¯ã¾ã å…¬é–‹ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
              <p style="font-size: 0.9em; margin-top: 8px;">å…¬é–‹ã‚’ãŠæ¥½ã—ã¿ã«!</p>
            </div>
          `}
        </div>
      `;
    }

    // åˆæœŸåŒ–
    loadAllStats();
  </script>
</body>
