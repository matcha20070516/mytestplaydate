<!DOCTYPE html>

<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>模試統計 - TExAM</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

```
body {
  font-family: "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  background: #f6f8fb;
  padding: 20px;
  min-height: 100vh;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
}

/* ヘッダー */
.header {
  background: white;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

h1 {
  color: #333;
  font-size: 1.8em;
}

.back-btn {
  background: #e0e0e0;
  color: #333;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9em;
  transition: background 0.2s;
}

.back-btn:hover {
  background: #d0d0d0;
}

.header-desc {
  color: #666;
  font-size: 0.95em;
  margin-top: 8px;
}

/* 統計カード */
.stats-grid {
  display: grid;
  gap: 20px;
  margin-bottom: 20px;
}

.exam-card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s;
}

.exam-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
}

.exam-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid #f0f0f0;
}

.exam-title {
  font-size: 1.4em;
  font-weight: 600;
  color: #333;
}

.exam-status {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.85em;
  font-weight: 600;
}

.exam-status.published {
  background: #e8f5e9;
  color: #2e7d32;
}

.exam-status.coming-soon {
  background: #fff3e0;
  color: #e65100;
}

/* 統計表示 */
.stats-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.stat-box {
  background: #f8f9fa;
  padding: 16px;
  border-radius: 12px;
  text-align: center;
  border: 2px solid #e0e0e0;
}

.stat-label {
  font-size: 0.85em;
  color: #666;
  margin-bottom: 6px;
}

.stat-value {
  font-size: 1.8em;
  font-weight: 700;
  color: #5da3fa;
}

/* 級別分布グラフ */
.grade-distribution {
  margin-top: 20px;
}

.grade-distribution h3 {
  font-size: 1.1em;
  color: #333;
  margin-bottom: 16px;
}

.bar-item {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}

.bar-label {
  min-width: 60px;
  font-size: 0.95em;
  font-weight: 600;
  color: #555;
}

.bar-container {
  flex: 1;
  height: 32px;
  background: #e0e0e0;
  border-radius: 6px;
  overflow: hidden;
  position: relative;
}

.bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #5da3fa 0%, #3c84e6 100%);
  transition: width 0.8s ease;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 10px;
  color: white;
  font-size: 0.9em;
  font-weight: 600;
}

.bar-info {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 80px;
  justify-content: flex-end;
}

.bar-percent {
  font-size: 0.95em;
  color: #666;
  font-weight: 600;
}

.bar-count {
  font-size: 0.85em;
  color: #999;
}

/* ローディング・空状態 */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.loading-icon {
  font-size: 3em;
  margin-bottom: 16px;
  animation: spin 2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-icon {
  font-size: 4em;
  margin-bottom: 16px;
}

.info-box {
  background: #e3f2fd;
  border-left: 4px solid #2196f3;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  color: #1565c0;
  font-size: 0.95em;
}
```

  </style>
</head>
<body>
  <div class="container">
    <!-- ヘッダー -->
    <div class="header">
      <div class="header-top">
        <h1>📊 模試統計</h1>
        <button class="back-btn" onclick="location.href='index.html'">← ホームへ</button>
      </div>
      <p class="header-desc">各模試の統計データを公開しています</p>
    </div>

```
<div class="info-box">
  💡 統計データは受験から1週間後に自動公開されます。データがない場合は公開待ちです。
</div>

<!-- 統計一覧 -->
<div id="statsGrid" class="stats-grid">
  <div class="loading">
    <div class="loading-icon">📈</div>
    <p>統計データを読み込み中...</p>
  </div>
</div>
```

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBhnEso3ozk4xG0k9x-69DC0HrKs8flzeU",
      authDomain: "mytestplaydate-4bc69.firebaseapp.com",
      projectId: "mytestplaydate-4bc69",
      storageBucket: "mytestplaydate-4bc69.firebasestorage.app",
      messagingSenderId: "995628219885",
      appId: "1:995628219885:web:333b93e79445febd3fbbe4",
      measurementId: "G-H1XRB359QB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 統計データを読み込み
    async function loadAllStats() {
      const statsGrid = document.getElementById('statsGrid');
      
      try {
        const statsSnapshot = await getDocs(collection(db, "examStats"));
        
        if (statsSnapshot.empty) {
          statsGrid.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">📭</div>
              <p>まだ統計データがありません</p>
              <p style="font-size: 0.9em; margin-top: 8px;">模試を受験すると統計が表示されます</p>
            </div>
          `;
          return;
        }

        const statsArray = [];
        statsSnapshot.forEach(doc => {
          const data = doc.data();
          statsArray.push({
            id: doc.id,
            ...data
          });
        });

        // 更新日時でソート
        statsArray.sort((a, b) => {
          const aTime = a.lastUpdated?.seconds || 0;
          const bTime = b.lastUpdated?.seconds || 0;
          return bTime - aTime;
        });

        // カード表示
        statsGrid.innerHTML = statsArray.map(exam => renderExamCard(exam)).join('');

        // アニメーション開始
        setTimeout(() => {
          document.querySelectorAll('.bar-fill').forEach(bar => {
            bar.style.width = bar.getAttribute('data-width');
          });
        }, 100);

      } catch (error) {
        console.error("統計読み込みエラー:", error);
        statsGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">⚠️</div>
            <p>統計データの読み込みに失敗しました</p>
            <p style="font-size: 0.9em; margin-top: 8px; color: #666;">${error.message}</p>
          </div>
        `;
      }
    }

    // 統計カードを生成
    function renderExamCard(exam) {
      const average = Math.round(exam.totalScore / exam.totalCount);
      
      // 公開判定（1週間経過チェック）
      const now = new Date();
      const createdAt = exam.createdAt?.toDate?.() || new Date(exam.createdAt);
      const daysPassed = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
      const isPublished = exam.isPublished || daysPassed >= 7;

      // 級別分布データ
      const gradeOrder = ['1', '準1', '2', '準2', '3', '4', '5', '6', '7', '8'];
      const gradeDistribution = gradeOrder.map(g => {
        const key = `grade_${g}`;
        const count = exam.gradeCount?.[key] || 0;
        const percent = exam.totalCount > 0 ? Math.round((count / exam.totalCount) * 100) : 0;
        return {
          grade: g + '級',
          count,
          percent
        };
      }).filter(g => g.count > 0); // 0人の級は非表示

      return `
        <div class="exam-card">
          <div class="exam-header">
            <h2 class="exam-title">${exam.setName || exam.id}</h2>
            <span class="exam-status ${isPublished ? 'published' : 'coming-soon'}">
              ${isPublished ? '公開中' : `公開まで ${7 - daysPassed}日`}
            </span>
          </div>

          ${isPublished ? `
            <div class="stats-summary">
              <div class="stat-box">
                <div class="stat-label">平均点</div>
                <div class="stat-value">${average}</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">受験者数</div>
                <div class="stat-value">${exam.totalCount}</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">最高点</div>
                <div class="stat-value">?</div>
              </div>
            </div>

            <div class="grade-distribution">
              <h3>級別分布</h3>
              ${gradeDistribution.map(g => `
                <div class="bar-item">
                  <div class="bar-label">${g.grade}</div>
                  <div class="bar-container">
                    <div class="bar-fill" style="width: 0%" data-width="${g.percent}%">
                      ${g.percent >= 10 ? g.percent + '%' : ''}
                    </div>
                  </div>
                  <div class="bar-info">
                    <span class="bar-percent">${g.percent}%</span>
                    <span class="bar-count">(${g.count}人)</span>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : `
            <div style="text-align: center; padding: 40px 20px; color: #999;">
              <div style="font-size: 3em; margin-bottom: 16px;">🔒</div>
              <p>この模試の統計はまだ公開されていません</p>
              <p style="font-size: 0.9em; margin-top: 8px;">公開をお楽しみに!</p>
            </div>
          `}
        </div>
      `;
    }

    // 初期化
    loadAllStats();
  </script>

</body>
</html>
